<<<<<<< HEAD
<!-- Panel Overlay -->
<div id="panelOverlay" class="panel-overlay"></div>

<!-- Slide Panel -->
<div id="uploadPanel" class="slide-panel">
    <!-- Panel Header -->
    <div class="panel-header">
        <h3 class="title-slide-panel">Cargar Archivo Excel</h3>
        <button id="closeUploadPanel" class="close-panel" aria-label="Cerrar panel">&times;</button>
    </div>

    <!-- Panel Content -->
    <div class="upload-panel-body">
        <!-- Status Messages -->
        <div class="panel-section" id="statusMessageSection" style="display: none;">
            <div id="statusMessage" class="result-message"></div>
        </div>

        <!-- Data Source Selector -->
        <div class="panel-section">
            <label for="fuenteDatosSelector" class="panel-label">üìä Fuente de datos</label>
            <select id="fuenteDatosSelector" class="selector-fuente">
                <option value="blueyonder">BlueYonder</option>
                <option value="wep">WEP</option>
            </select>
        </div>

        <!-- Upload Excel Section -->
        <div class="panel-section">
            <h4>üìÅ Subir Archivo Excel</h4>
            <div class="upload-method file-upload">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-placeholder">
                        <div class="upload-icon">üìÅ</div>
                        <p>Haz clic aqu√≠ o arrastra tu archivo</p>
                        <div style="font-size: 0.9em; color: #adb5bd; margin-top: 5px;">Formatos: .xlsx, .xls</div>
                        <button id="selectButton" class="btn-upload">
                            Seleccionar Archivo
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none">
                </div>
            </div>
        </div>

        <!-- Drive Files Section -->
        <div class="panel-section">
            <h4>üíæ Archivos en Drive</h4>
            <div class="upload-method drive-upload">
                <div class="drive-selector">
                    <button id="selectDriveButton" class="btn-secondary">
                        üìÇ Seleccionar de Drive
                    </button>
                    <div id="driveFiles" class="drive-files-container" style="display: none;">
                        <!-- Drive files will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected File Display -->
        <div class="panel-section" id="fileInfoSection" style="display: none;">
            <h4>‚úÖ Archivo seleccionado</h4>
            <div class="file-info-container">
                <div class="file-details">
                    <div class="file-info">
                        <strong>Archivo:</strong> <span id="fileName">--</span>
                    </div>
                    <div class="file-info">
                        <strong>Tama√±o:</strong> <span id="fileSize">--</span>
                    </div>
                </div>
                <button class="file-remove-btn" onclick="uploadManager.resetPanel()" title="Quitar archivo">&times;</button>
            </div>
        </div>

        <!-- Date Selector -->
        <div class="panel-section" id="dateSection" style="display: none;">
            <h4>üìÖ Fecha del Archivo</h4>
            <div class="date-selector">
                <div class="input-group">
                    <label for="fileDate">Fecha:</label>
                    <input type="date" id="fileDate" class="fecha-input">
                </div>
                <div class="input-group">
                    <label for="fileTime">Hora:</label>
                    <input type="time" id="fileTime" class="hora-input" value="00:00">
                </div>
                <div class="input-hint">
                    Si no seleccionas fecha, se usar√° la fecha actual
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="panel-section" id="progressSection" style="display: none;">
            <h4>‚è≥ Progreso</h4>
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s;"></div>
                </div>
                <div class="process-status">
                    <span id="progressText">Procesando...</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="panel-section">
            <div class="button-group">
                <button id="processFileButton" class="btn-primary" disabled>
                    üîÑ Procesar Archivo
                </button>
                <button id="cancelProcessButton" class="btn-secondary" style="display: none;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="panel-section" id="resultsSection" style="display: none;">
            <div id="uploadResult" class="upload-result"></div>
        </div>

        <!-- Historial Section -->
        <div class="historial-section">
            <h4>üìú Historial de Archivos</h4>
            <div class="historial-controls">
                <button id="refreshHistorialButton" class="btn-secondary">
                    üîÑ Actualizar Lista
                </button>
                <button id="clearHistorialButton" class="btn-secondary">
                    üóëÔ∏è Limpiar Temporales
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * File Upload Panel Manager
 * Handles file uploads, Drive integration, and processing
 */
class FileUploadManager {
    constructor() {
        this.selectedFile = null;
        this.driveFiles = [];
        this.isProcessing = false;
        this.init();
    }

    init() {
        this.setupElements();
        this.setupEventListeners();
        this.loadDataSourcePreference();
    }

    setupElements() {
        // Panel elements
        this.uploadPanel = document.getElementById('uploadPanel');
        this.panelOverlay = document.getElementById('panelOverlay');
        this.uploadButton = document.getElementById('uploadButton');
        this.closeButton = document.getElementById('closeUploadPanel');

        // Upload elements
        this.fileInput = document.getElementById('fileInput');
        this.selectButton = document.getElementById('selectButton');
        this.uploadArea = document.getElementById('uploadArea');
        this.driveButton = document.getElementById('selectDriveButton');
        this.driveFilesList = document.getElementById('driveFiles');

        // Info elements
        this.fileInfoSection = document.getElementById('fileInfoSection');
        this.fileName = document.getElementById('fileName');
        this.fileSize = document.getElementById('fileSize');

        // Date elements
        this.dateSection = document.getElementById('dateSection');
        this.fileDate = document.getElementById('fileDate');
        this.fileTime = document.getElementById('fileTime');

        // Progress elements
        this.progressSection = document.getElementById('progressSection');
        this.progressBar = document.getElementById('progressBar');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');

        // Control elements
        this.processButton = document.getElementById('processFileButton');
        this.cancelButton = document.getElementById('cancelProcessButton');
        this.dataSourceSelector = document.getElementById('fuenteDatosSelector');

        // Results
        this.resultsSection = document.getElementById('resultsSection');
        this.uploadResult = document.getElementById('uploadResult');
    }

    setupEventListeners() {
        // Panel controls
        if (this.uploadButton) {
            this.uploadButton.addEventListener('click', () => this.openPanel());
        }

        if (this.closeButton) {
            this.closeButton.addEventListener('click', () => this.closePanel());
        }

        if (this.panelOverlay) {
            this.panelOverlay.addEventListener('click', () => this.closePanel());
        }

        // File selection
        if (this.selectButton && this.fileInput) {
            this.selectButton.addEventListener('click', () => this.fileInput.click());
            this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        }

        // Drive selection
        if (this.driveButton) {
            this.driveButton.addEventListener('click', () => this.showDriveFiles());
        }

        // Processing
        if (this.processButton) {
            this.processButton.addEventListener('click', () => this.processFile());
        }

        if (this.cancelButton) {
            this.cancelButton.addEventListener('click', () => this.cancelProcessing());
        }

        // Data source
        if (this.dataSourceSelector) {
            this.dataSourceSelector.addEventListener('change', (e) => {
                this.updateDataSource(e.target.value);
            });
        }

        // Drag and drop
        if (this.uploadArea) {
            this.setupDragAndDrop();
        }
    }

    setupDragAndDrop() {
        this.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            this.uploadArea.classList.add('drag-over');
        });

        this.uploadArea.addEventListener('dragleave', () => {
            this.uploadArea.classList.remove('drag-over');
        });

        this.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            this.uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.handleFileSelection(files[0]);
            }
        });
    }

    openPanel() {
        if (this.uploadPanel && this.panelOverlay) {
            this.uploadPanel.classList.add('active');
            this.panelOverlay.classList.add('active');
            document.body.classList.add('panel-open');
        }
    }

    closePanel() {
        if (this.uploadPanel && this.panelOverlay) {
            this.uploadPanel.classList.remove('active');
            this.panelOverlay.classList.remove('active');
            document.body.classList.remove('panel-open');
            this.resetPanel();
        }
    }

    resetPanel() {
        this.selectedFile = null;
        this.hideSection(this.fileInfoSection);
        this.hideSection(this.dateSection);
        this.hideSection(this.progressSection);
        this.hideSection(this.resultsSection);
        this.processButton.disabled = true;
        this.isProcessing = false;
        
        if (this.fileInput) {
            this.fileInput.value = '';
        }
    }

    handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            this.handleFileSelection(file);
        }
    }

    handleFileSelection(file) {
        if (!this.validateFile(file)) {
            return;
        }

        this.selectedFile = file;
        this.showFileInfo(file);
        this.showSection(this.dateSection);
        this.processButton.disabled = false;
    }

    validateFile(file) {
        const validTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-excel'
        ];

        if (!validTypes.includes(file.type)) {
            this.showError('Tipo de archivo no v√°lido. Solo se permiten archivos Excel (.xlsx, .xls)');
            return false;
        }

        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
            this.showError('El archivo es demasiado grande. Tama√±o m√°ximo: 50MB');
            return false;
        }

        return true;
    }

    showFileInfo(file) {
        this.fileName.textContent = file.name;
        this.fileSize.textContent = this.formatFileSize(file.size);
        this.showSection(this.fileInfoSection);
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async showDriveFiles() {
        try {
            this.driveButton.disabled = true;
            this.driveButton.textContent = 'Cargando...';

            const files = await this.loadDriveFiles();
            this.displayDriveFiles(files);

        } catch (error) {
            console.error('Error loading drive files:', error);
            this.showError('Error al cargar archivos de Drive');
        } finally {
            this.driveButton.disabled = false;
            this.driveButton.textContent = 'Seleccionar de Drive';
        }
    }

    async loadDriveFiles() {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .obtenerArchivosExcel();
        });
    }

    displayDriveFiles(files) {
        this.driveFiles = files;
        this.driveFilesList.innerHTML = '';

        if (files.length === 0) {
            this.driveFilesList.innerHTML = '<p class="no-files">No se encontraron archivos Excel</p>';
        } else {
            files.forEach(file => {
                const fileElement = this.createDriveFileElement(file);
                this.driveFilesList.appendChild(fileElement);
            });
        }

        this.driveFilesList.style.display = 'block';
    }

    createDriveFileElement(file) {
        const div = document.createElement('div');
        div.className = 'drive-file-item';
        div.innerHTML = `
            <div class="file-icon">üìÑ</div>
            <div class="file-info">
                <div class="file-name">${file.nombre}</div>
                <div class="file-date">${new Date(file.fecha).toLocaleDateString()}</div>
            </div>
            <button class="btn btn-sm select-drive-file" data-file-id="${file.id}">
                Seleccionar
            </button>
        `;

        const selectButton = div.querySelector('.select-drive-file');
        selectButton.addEventListener('click', () => {
            this.selectDriveFile(file);
        });

        return div;
    }

    selectDriveFile(file) {
        this.selectedFile = {
            id: file.id,
            name: file.nombre,
            isDriveFile: true
        };

        this.showFileInfo({
            name: file.nombre,
            size: file.tama√±o || 0
        });

        this.showSection(this.dateSection);
        this.processButton.disabled = false;
        this.driveFilesList.style.display = 'none';
    }

    async processFile() {
        if (!this.selectedFile || this.isProcessing) {
            return;
        }

        this.isProcessing = true;
        this.processButton.disabled = true;
        this.processButton.textContent = 'Procesando...';
        this.cancelButton.style.display = 'block';

        this.showSection(this.progressSection);
        this.updateProgress(0, 'Iniciando procesamiento...');

        try {
            let result;
            
            if (this.selectedFile.isDriveFile) {
                result = await this.processDriveFile();
            } else {
                result = await this.processUploadedFile();
            }

            this.handleProcessingResult(result);

        } catch (error) {
            console.error('Error processing file:', error);
            this.showError('Error al procesar el archivo: ' + error.message);
        } finally {
            this.isProcessing = false;
            this.processButton.disabled = false;
            this.processButton.textContent = 'Procesar Archivo';
            this.cancelButton.style.display = 'none';
        }
    }

    async processDriveFile() {
        const customTimestamp = this.getCustomTimestamp();
        
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .procesarArchivoExcelDrive(this.selectedFile.id, customTimestamp, true);
        });
    }

    async processUploadedFile() {
        const customTimestamp = this.getCustomTimestamp();
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const base64data = e.target.result.split(',')[1];
                
                const data = {
                    base64data: base64data,
                    fileName: this.selectedFile.name,
                    useCustomDate: !!customTimestamp,
                    timestamp: customTimestamp
                };

                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .procesarArchivoExcelSeguro(data);
            };
            
            reader.onerror = () => reject(new Error('Error reading file'));
            reader.readAsDataURL(this.selectedFile);
        });
    }

    getCustomTimestamp() {
        if (this.fileDate.value && this.fileTime.value) {
            const dateTime = new Date(`${this.fileDate.value}T${this.fileTime.value}`);
            return dateTime.getTime();
        }
        return null;
    }

    handleProcessingResult(result) {
        if (result.status === 'success') {
            this.showSuccess(result.message + ' - El dashboard se actualizar√° autom√°ticamente en unos segundos.');
            this.updateProgress(100, 'Procesamiento completado');
            
            // Trigger data refresh
            console.log('Programando recarga de datos en 3 segundos...');
            setTimeout(() => {
                console.log('Iniciando recarga de datos del dashboard...');
                
                // Cargar el SVG base con datos despu√©s del procesamiento
                if (window.cargarSVGBase) {
                    console.log('Cargando SVG base con datos...');
                    window.cargarSVGBase(true); // true para cargar datos despu√©s
                } else if (window.cargarDatosUbicaciones) {
                    console.log('Llamando a cargarDatosUbicaciones...');
                    window.cargarDatosUbicaciones();
                } else {
                    console.error('Funciones de carga no est√°n disponibles');
                }
                
                // Tambi√©n intentar recargar otros componentes
                if (window.cargarCalendario) {
                    console.log('Recargando calendario...');
                    window.cargarCalendario();
                }
                
                if (window.actualizarStats) {
                    console.log('Actualizando estad√≠sticas...');
                    window.actualizarStats();
                }
                
                // Despu√©s de intentar recargar, mostrar opci√≥n manual
                setTimeout(() => {
                    const refreshButton = document.createElement('button');
                    refreshButton.textContent = 'üîÑ Recargar Dashboard Manualmente';
                    refreshButton.className = 'btn-secondary';
                    refreshButton.style.marginTop = '10px';
                    refreshButton.onclick = () => {
                        console.log('Recarga manual iniciada...');
                        window.location.reload();
                    };
                    
                    const resultsSection = document.getElementById('uploadResult');
                    if (resultsSection && !resultsSection.querySelector('.manual-refresh')) {
                        refreshButton.classList.add('manual-refresh');
                        resultsSection.appendChild(refreshButton);
                    }
                }, 2000);
            }, 3000);
        } else {
            this.showError(result.message || 'Error desconocido');
        }
    }

    async cancelProcessing() {
        if (!this.isProcessing) {
            return;
        }

        try {
            await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .cancelarProcesamiento();
            });

            this.updateProgress(0, 'Procesamiento cancelado');
            this.showError('Procesamiento cancelado por el usuario');

        } catch (error) {
            console.error('Error canceling processing:', error);
        }
    }

    updateProgress(percentage, message) {
        if (this.progressFill) {
            this.progressFill.style.width = `${percentage}%`;
        }
        
        if (this.progressText) {
            this.progressText.textContent = message;
        }
    }

    showSuccess(message) {
        this.showResult(message, 'success');
    }

    showError(message) {
        this.showResult(message, 'error');
    }

    showResult(message, type) {
        // Show in results section
        if (this.uploadResult) {
            this.uploadResult.innerHTML = `
                <div class="result-message ${type}">
                    <div class="result-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</div>
                    <div class="result-text">${message}</div>
                </div>
            `;
        }
        this.showSection(this.resultsSection);

        // Also show in status message section at the top
        const statusMessageSection = document.getElementById('statusMessageSection');
        const statusMessage = document.getElementById('statusMessage');
        if (statusMessage && statusMessageSection) {
            statusMessage.innerHTML = `
                <div class="result-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</div>
                <div class="result-text">${message}</div>
            `;
            statusMessage.className = `result-message ${type}`;
            statusMessageSection.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (statusMessageSection) {
                        statusMessageSection.style.display = 'none';
                    }
                }, 5000);
            }
        }
    }

    showSection(section) {
        if (section) {
            section.style.display = 'block';
        }
    }

    hideSection(section) {
        if (section) {
            section.style.display = 'none';
        }
    }

    loadDataSourcePreference() {
        const saved = localStorage.getItem('dataSource');
        if (saved && this.dataSourceSelector) {
            this.dataSourceSelector.value = saved;
        }
    }

    updateDataSource(source) {
        localStorage.setItem('dataSource', source);
        
        // Update server-side preference
        google.script.run
            .withSuccessHandler(() => {
                console.log('Data source updated:', source);
            })
            .withFailureHandler((error) => {
                console.error('Error updating data source:', error);
            })
            .actualizarFuenteDatos(source);
    }
}

// Initialize upload manager
let uploadManager;

document.addEventListener('DOMContentLoaded', function() {
    uploadManager = new FileUploadManager();
});

// Export for backward compatibility
window.setupUploadPanel = function() {
    if (!uploadManager) {
        uploadManager = new FileUploadManager();
    }
};
</script>
=======
<script>
  // Variables globales esenciales para el panel de carga
  let selectedFile = null;
  let driveFiles = [];

  const uploadPanel = document.getElementById("uploadPanel");
  const panelOverlay = document.getElementById("panelOverlay");
  const uploadButton = document.getElementById("uploadButton");
  const closeUploadPanelBtn = document.getElementById("closeUploadPanel");
  const fileInput = document.getElementById("fileInput");
  const selectButton = document.getElementById("selectButton");
  const uploadArea = document.getElementById("uploadArea");
  const fileInfo = document.getElementById("fileInfo");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const uploadResult = document.getElementById("uploadResult");
  const processFileButton = document.getElementById("processFileButton");

  const cancelProcessButton = document.createElement("button");
  cancelProcessButton.id = "cancelProcessButton";
  cancelProcessButton.className = "btn btn-secondary";
  cancelProcessButton.textContent = "Cancelar";
  cancelProcessButton.style.display = "none";
  cancelProcessButton.addEventListener("click", cancelarProcesamiento);

  // Inicializaci√≥n para el panel de carga (agregar a tu DOMContentLoaded existente)
  window.setupUploadPanel = function () {
    // Event listeners para panel deslizable
    if (uploadButton) {
      uploadButton.addEventListener("click", openUploadPanel);
    }

    if (closeUploadPanelBtn) {
      closeUploadPanelBtn.addEventListener("click", closeUploadPanel);
    }

    if (panelOverlay) {
      panelOverlay.addEventListener("click", closeAllPanels);
    }

    // Event listeners para carga de archivos
    if (selectButton && fileInput) {
      selectButton.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", handleFileSelect);
    }

    if (processFileButton) {
      processFileButton.addEventListener("click", function () {
        console.log("Bot√≥n procesar archivo clickeado");
        processSelectedFile();
      });
    }

    // Soporte para arrastrar y soltar
    if (uploadArea) {
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, () => {
          uploadArea.classList.add("highlight");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, () => {
          uploadArea.classList.remove("highlight");
        });
      });

      uploadArea.addEventListener("drop", handleFileDrop);
    }

    // Seleccionar archivo Drive
    if (document.getElementById("selectDriveButton")) {
      document
        .getElementById("selectDriveButton")
        .addEventListener("click", function () {
          console.log("Solicitando archivos de Drive");
          mostrarCargaDrive(true);

          // Solicitar archivos al servidor
          google.script.run
            .withSuccessHandler(function (files) {
              mostrarCargaDrive(false);
              if (files && Array.isArray(files) && files.length > 0) {
                driveFiles = files;
                mostrarSelectorArchivos(files);
              } else {
                alert(
                  "No se encontraron archivos Excel en la carpeta seleccionada"
                );
              }
            })
            .withFailureHandler(function (error) {
              mostrarCargaDrive(false);
              console.error("Error al obtener archivos:", error);
              alert("Error al obtener los archivos de Drive");
            })
            .obtenerArchivosExcel();
        });
    }
  };

  // Funciones para panel deslizable
  function openUploadPanel() {
    if (uploadPanel && panelOverlay) {
      uploadPanel.classList.add("open");
      panelOverlay.classList.add("open");
    }
  }

  function closeUploadPanel() {
    if (uploadPanel && panelOverlay) {
      uploadPanel.classList.remove("open");
      panelOverlay.classList.remove("open");
    }
  }

  function closeAllPanels() {
    if (uploadPanel && panelOverlay) {
      uploadPanel.classList.remove("open");
      panelOverlay.classList.remove("open");
    }
  }

  // Prevenir comportamiento predeterminado para eventos de arrastrar y soltar
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Manejar selecci√≥n de archivo
  function handleFileSelect(e) {
    if (e.target.files.length > 0) {
      selectedFile = e.target.files[0];
      displayFileInfo(selectedFile);
      if (processFileButton) {
        processFileButton.disabled = false;
      }
    }
  }

  // Manejar archivo soltado en √°rea de carga
  function handleFileDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length > 0) {
      selectedFile = files[0];
      displayFileInfo(selectedFile);
      if (processFileButton) {
        processFileButton.disabled = false;
      }
    }
  }

  // Mostrar informaci√≥n del archivo seleccionado
  function displayFileInfo(file) {
    if (fileInfo) {
      const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
      fileInfo.innerHTML = `
          <div class="file-info-container">
            <div class="file-details">
              <strong>${file.name}</strong> (${sizeInMB} MB)
            </div>
            <button class="file-remove-btn" id="removeFileBtn">&times;</button>
          </div>
        `;

      // Mostrar el selector de fecha
      const fileDateSelector = document.getElementById("fileDateSelector");
      if (fileDateSelector) {
        fileDateSelector.style.display = "block";

        // Establecer fecha por defecto (hoy)
        const today = new Date();
        const formattedDate = today.toISOString().split("T")[0]; // formato YYYY-MM-DD
        const fileDate = document.getElementById("fileDate");

        // Formatear hora actual
        const currentHour = today.getHours().toString().padStart(2, "0");
        const currentMinutes = today.getMinutes().toString().padStart(2, "0");
        const currentTime = `${currentHour}:${currentMinutes}`;

        if (fileDate) {
          fileDate.value = formattedDate;
        }

        // Establecer hora actual por defecto
        const fileTime = document.getElementById("fileTime");
        if (fileTime) {
          fileTime.value = currentTime;
        }
      }

      // A√±adir listener para el bot√≥n de eliminar
      const removeFileBtn = document.getElementById("removeFileBtn");
      if (removeFileBtn) {
        removeFileBtn.addEventListener("click", removeSelectedFile);
      }
    }
  }

  function removeSelectedFile() {
    selectedFile = null;
    if (fileInfo) {
      fileInfo.innerHTML = "";
    }

    if (fileInput) {
      fileInput.value = ""; // Limpiar el input de archivo
    }

    const fileDateSelector = document.getElementById("fileDateSelector");
    if (fileDateSelector) {
      fileDateSelector.style.display = "none";
    }

    if (processFileButton) {
      processFileButton.disabled = true;
      removeFileBtn.disabled = true;
    }
  }

  function cancelarProcesamiento() {
    if (window.processingCancelled !== undefined) {
      window.processingCancelled = true;
      updateProcessStatus("Cancelando procesamiento...");
      cancelProcessButton.disabled = true;
    }
  }

  function processSelectedFile() {
    if (processFileButton) {
      processFileButton.disabled = true;
      if (removeFileBtn) removeFileBtn.disabled = true;
    }

    window.processingCancelled = false;
    if (cancelProcessButton) {
      cancelProcessButton.style.display = "inline-block";
      cancelProcessButton.disabled = false;
    }

    console.log("Iniciando procesamiento de archivo...");

    if (!selectedFile) {
      console.log("No hay archivo seleccionado");
      showNotification("Por favor seleccione un archivo", false);
      if (processFileButton) {
        processFileButton.disabled = false;
        removeFileBtn.disabled = false;
      }
      return;
    }

    let selectedDate = null;

    // Si es un archivo de Drive, usar fecha extra√≠da si existe
    if (selectedFile.fromDrive && selectedFile.extractedDate) {
      selectedDate = selectedFile.extractedDate;
      console.log(
        "Usando fecha extra√≠da del nombre del archivo:",
        selectedDate
      );
    } else {
      // Para archivos subidos, usar selector de fecha
      const fileDate = document.getElementById("fileDate");
      const fileTime = document.getElementById("fileTime");

      if (fileDate && fileDate.value) {
        const dateParts = fileDate.value.split("-");
        // Establecer hora actual si no se especifica
        let hours = 0;
        let minutes = 0;

        if (fileTime && fileTime.value) {
          const timeParts = fileTime.value.split(":");
          hours = parseInt(timeParts[0]);
          minutes = parseInt(timeParts[1]);
        } else {
          // Usar hora actual si no se especifica
          const now = new Date();
          hours = now.getHours();
          minutes = now.getMinutes();
        }

        selectedDate = new Date(
          parseInt(dateParts[0]), // a√±o
          parseInt(dateParts[1]) - 1, // mes (0-11)
          parseInt(dateParts[2]), // d√≠a
          hours, // hora (actual si no se especifica)
          minutes // minutos (actual si no se especifica)
        );
      }
    }

    if (selectedDate === null || isNaN(selectedDate.getTime())) {
      console.error("Fecha seleccionada inv√°lida o nula:", selectedDate);
      selectedDate = null;
    } else {
      console.log(
        "Fecha seleccionada v√°lida:",
        selectedDate,
        "Timestamp:",
        selectedDate.getTime()
      );
    }

    // Mostrar progreso
    if (progressContainer) {
      console.log("Mostrando progreso");
      progressContainer.style.display = "block";
      progressBar.innerHTML =
        '<div class="loader"></div><div class="process-status">Preparando archivo...</div>';
    }

    // Procesar el archivo
    if (selectedFile.fromDrive) {
      procesarArchivoDrive(selectedFile.id, selectedDate);
    } else {
      procesarArchivo(selectedDate);
    }
  }

  function procesarArchivo(selectedDate) {
    console.log(
      "Procesando archivo:",
      selectedFile.name,
      "Tama√±o:",
      selectedFile.size
    );
    updateProcessStatus("Leyendo archivo...");

    const reader = new FileReader();

    reader.onload = function (e) {
      try {
        updateProcessStatus("Convirtiendo archivo...");
        const arrayBuffer = e.target.result;
        console.log("Archivo le√≠do correctamente. Convirtiendo a base64...");

        // A√±adir un peque√±o retraso para permitir que la UI se actualice
        setTimeout(() => {
          try {
            const base64data = arrayBufferToBase64(arrayBuffer);
            console.log(
              "Conversi√≥n a base64 completa. Longitud:",
              base64data.length
            );
            updateProcessStatus("Guardando en Drive...");
            enviarArchivoAlServidor(
              base64data,
              selectedFile.name,
              selectedDate
            );
          } catch (error) {
            console.error("Error en conversi√≥n a base64:", error);
            handleError("Error al convertir el archivo: " + error.message);
          }
        }, 100);
      } catch (error) {
        console.error("Error en procesamiento de archivo:", error);
        handleError("Error al procesar el archivo: " + error.message);
      }
    };

    reader.onerror = function (error) {
      console.error("Error al leer el archivo:", error);
      handleError("Error al leer el archivo");
    };

    // Leer el archivo como ArrayBuffer
    console.log("Iniciando lectura del archivo como ArrayBuffer");
    reader.readAsArrayBuffer(selectedFile);
  }

  function procesarArchivoDrive(fileId, selectedDate) {
    updateProcessStatus("Procesando archivo de Drive...");

    // A√±adir indicador para el servidor de que es un archivo existente
    const useExistingFile = true;

    google.script.run
      .withSuccessHandler(function (result) {
        if (result && result.status === "success") {
          updateProcessStatus("Generando mapa...");

          // Solicitar actualizaci√≥n del mapa
          google.script.run
            .withSuccessHandler(function (mapResult) {
              console.log("Mapa actualizado correctamente:", mapResult);

              if (processFileButton) {
                processFileButton.disabled = false;
              }

              if (progressContainer) {
                progressContainer.style.display = "none";
              }

              showNotification("Archivo procesado correctamente", true);

              setTimeout(() => {
                closeUploadPanel();
                showNotification(
                  "Recargando p√°gina para mostrar cambios...",
                  true
                );

                // Recargar completamente la p√°gina despu√©s de un breve retardo
                setTimeout(() => {
                  window.location.reload(true);
                }, 1500);
              }, 1000);
            })
            .withFailureHandler(function (error) {
              console.error("Error al actualizar mapa:", error);
              handleError(error);
            })
            .actualizarSVG();
        } else {
          const errorMsg =
            result && result.message
              ? result.message
              : "Error desconocido en el servidor";
          console.error("Error en procesamiento del servidor:", errorMsg);
          handleError(errorMsg);
        }
      })
      .withFailureHandler(function (error) {
        console.error("Error al procesar archivo de Drive:", error);
        handleError(error);
      })
      .procesarArchivoExcelDrive(
        fileId,
        selectedDate ? selectedDate.getTime() : null,
        useExistingFile
      );
  }

  /**
   * Env√≠a el archivo procesado al servidor
   */
  function enviarArchivoAlServidor(base64data, fileName, selectedDate) {
    updateProcessStatus("Guardando en Drive...");
    if (window.processingCancelled) {
      handleCancel();
      return;
    }

    if (!base64data || typeof base64data !== "string") {
      handleError("Datos inv√°lidos para enviar al servidor");
      return;
    }

    console.log("Enviando archivo. Longitud base64:", base64data.length);

    // Crear objeto con los datos
    const datosParaEnviar = {
      base64data: base64data,
      fileName: fileName,
      timestamp: selectedDate ? selectedDate.getTime() : new Date().getTime(), // Usar la fecha seleccionada o la actual
      useCustomDate: !!selectedDate, // Indicar si estamos usando una fecha personalizada
    };

    // A√±adir timeout por si la solicitud tarda demasiado
    // const timeoutId = setTimeout(() => {
    //   handleError("La solicitud al servidor ha excedido el tiempo de espera (60 segundos)");
    // }, 60000);

    // Log para verificar que estamos llamando a google.script.run
    console.log("Llamando a google.script.run.procesarArchivoExcelSeguro");

    // Enviar al servidor
    google.script.run
      .withSuccessHandler(function (response) {
        // clearTimeout(timeoutId);
        console.log("Respuesta recibida del servidor:", response);

        if (response && response.status === "success") {
          console.log("Archivo procesado correctamente", response);
          updateProcessStatus("Generando mapa...");

          // Solicitar actualizaci√≥n del mapa
          google.script.run
            .withSuccessHandler(function (result) {
              console.log("Mapa actualizado correctamente:", result);

              if (processFileButton) {
                processFileButton.disabled = false;
              }

              if (progressContainer) {
                progressContainer.style.display = "none";
              }

              showNotification("Archivo procesado correctamente", true);
              if (window.mostrarTopVencimientos) {
                setTimeout(() => {
                  try {
                    window.datosVencimientos =
                      window.extraerVencimientosDeProductos(
                        window.datosProductos
                      );
                    window.mostrarTopVencimientos();
                  } catch (error) {
                    console.error("Error al extraer vencimientos:", error);
                  }
                }, 500);
              }

              setTimeout(() => {
                closeUploadPanel();
                showNotification(
                  "Recargando p√°gina para mostrar cambios...",
                  true
                );

                // Recargar completamente la p√°gina despu√©s de un breve retardo
                setTimeout(() => {
                  window.location.reload(true);
                }, 1500);
              }, 1000);
            })
            .withFailureHandler(function (error) {
              console.error("Error al actualizar mapa:", error);
              handleError(error);
            })
            .actualizarSVG();
        } else {
          const errorMsg =
            response && response.message
              ? response.message
              : "Error desconocido en el servidor";
          console.error("Error en procesamiento del servidor:", errorMsg);
          handleError(errorMsg);
        }
      })
      .withFailureHandler(function (error) {
        // clearTimeout(timeoutId);
        console.error("Error en procesarArchivoExcelSeguro:", error);
        handleError(error);
      })
      .procesarArchivoExcelSeguro(datosParaEnviar);
  }

  /**
   * Maneja errores de forma centralizada
   */
  function handleError(error) {
    showNotification("Error: " + error.toString(), false);
    console.log("Error: " + error.toString(), false);

    if (processFileButton) {
      processFileButton.disabled = false;
      processFileButton.innerText = "Procesar archivo";
    }

    // Ocultar el indicador de progreso
    if (progressContainer) {
      progressContainer.style.display = "none";
    }
  }

  function handleCancel() {
    if (processFileButton) {
      processFileButton.disabled = false;
    }

    if (cancelProcessButton) {
      cancelProcessButton.style.display = "none";
    }

    if (progressContainer) {
      progressContainer.style.display = "none";
    }

    showNotification("Procesamiento cancelado por el usuario", false);
  }

  function updateProcessStatus(message) {
    const statusElement = document.querySelector(".process-status");
    if (statusElement) {
      statusElement.textContent = message;
    } else {
      const progressBar = document.getElementById("progressBar");
      if (progressBar) {
        // Si no existe el elemento, crearlo
        const statusDiv = document.createElement("div");
        statusDiv.className = "process-status";
        statusDiv.textContent = message;
        progressBar.appendChild(statusDiv);
      }
    }
  }

  // Reemplaza la funci√≥n arrayBufferToBase64 con esta versi√≥n mejorada
  function arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;

    // Limitar el tama√±o de los chunks para evitar call stack exceeded
    const CHUNK_SIZE = 1024;
    for (let i = 0; i < len; i += CHUNK_SIZE) {
      const slice = bytes.subarray(i, Math.min(i + CHUNK_SIZE, len));
      const chunk = Array.from(slice);
      const binaryChunk = String.fromCharCode.apply(null, chunk);
      binary += binaryChunk;
    }

    return btoa(binary);
  }

  // Mostrar notificaci√≥n
  function showNotification(message, isSuccess) {
    if (!uploadResult) return;

    const notificationType = isSuccess
      ? "notification-success"
      : "notification-error";
    const notificationHtml = `
        <div class="notification ${notificationType}">
          <span>${message}</span>
        </div>
      `;

    uploadResult.innerHTML = notificationHtml;

    if (cancelProcessButton) {
      cancelProcessButton.style.display = "none";
    }
  }

  // SELECT ARCHIVO DRIVE
  function mostrarCargaDrive(mostrar) {
    const fileInfo = document.getElementById("fileInfo");
    if (fileInfo) {
      if (mostrar) {
        fileInfo.innerHTML =
          '<div class="loader"></div><p>Cargando archivos de Drive...</p>';
      } else {
        fileInfo.innerHTML = "";
      }
    }
  }

  function mostrarSelectorArchivos(files) {
    const fileInfo = document.getElementById("fileInfo");
    if (!fileInfo) return;

    // Verificar si hay archivos
    if (!files || files.length === 0) {
      fileInfo.innerHTML = "<p>No se encontraron archivos en Drive</p>";
      return;
    }

    // Crear un Set para almacenar los IDs de archivos ya procesados
    const processedFileIds = new Set();

    let html = '<div class="drive-files-container">';
    html += "<h4>Seleccione un archivo:</h4>";
    html += '<div class="drive-files-list">';

    files.forEach((file, index) => {
      // Verificar si este archivo ya fue procesado
      if (processedFileIds.has(file.id)) {
        return; // Saltar este archivo
      }

      // A√±adir el ID al conjunto de procesados
      processedFileIds.add(file.id);

      const fechaStr = file.fecha
        ? new Date(file.fecha).toLocaleString()
        : "Fecha desconocida";
      html += `
          <div class="drive-file-item" data-index="${index}">
            <div class="drive-file-icon">üìÑ</div>
            <div class="drive-file-info">
              <div class="drive-file-name">${file.nombre}</div>
              <div class="drive-file-date">${fechaStr}</div>
            </div>
          </div>
        `;
    });

    html += "</div></div>";
    fileInfo.innerHTML = html;

    // Agregar listeners a los archivos
    document.querySelectorAll(".drive-file-item").forEach((item) => {
      item.addEventListener("click", function () {
        const index = parseInt(this.getAttribute("data-index"));
        seleccionarArchivoDrive(driveFiles[index]);
      });
    });
  }

  function seleccionarArchivoDrive(file) {
    // Extraer fecha del nombre del archivo (Inventario_YYYY-MM-DD o Inventario_YYYYMMDD)
    let fechaExtraida = null;
    const regexConGuiones =
      /Inventario_(\d{2})_(\d{2})_(\d{4})_(\d{2})_(\d{2})/;
    const regexSinGuiones = /Inventario_(\d{2})(\d{2})(\d{4})_(\d{2})_(\d{2})/;

    let coincidencia =
      file.nombre.match(regexConGuiones) || file.nombre.match(regexSinGuiones);

    if (coincidencia) {
      const day = parseInt(coincidencia[1]);
      const month = parseInt(coincidencia[2]) - 1; // Los meses en JS van de 0-11
      const year = parseInt(coincidencia[3]);

      const hours = parseInt(coincidencia[4]);
      const minutes = parseInt(coincidencia[5]);

      fechaExtraida = new Date(year, month, day, hours, minutes);
      if (isNaN(fechaExtraida.getTime())) {
        fechaExtraida = null;
      }
    }

    selectedFile = {
      id: file.id,
      name: file.nombre,
      fromDrive: true,
      extractedDate: fechaExtraida,
    };

    const fileInfo = document.getElementById("fileInfo");
    if (fileInfo) {
      let fechaInfo = "";
      if (fechaExtraida) {
        fechaInfo = `<div class="file-date">Fecha detectada: ${fechaExtraida.toLocaleDateString()}</div>`;
      }

      fileInfo.innerHTML = `
          <div class="file-info-container">
            <div class="file-details">
              <strong>${file.nombre}</strong> (Google Drive)
              ${fechaInfo}
            </div>
            <button class="file-remove-btn" id="removeFileBtn">&times;</button>
          </div>
        `;

      // A√±adir listener para el bot√≥n de eliminar
      const removeFileBtn = document.getElementById("removeFileBtn");
      if (removeFileBtn) {
        removeFileBtn.addEventListener("click", removeSelectedFile);
      }
    }

    // Habilitar el bot√≥n de procesar
    if (processFileButton) {
      processFileButton.disabled = false;
    }
  }
</script>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
