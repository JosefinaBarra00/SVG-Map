<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<<<<<<< HEAD
    <meta
      name="description"
      content="Sistema de visualizaci√≥n de inventario de bodega CCU"
    />
    <title><?= TITULO ?></title>

    <!-- Estilos refactorizados -->
    <?!= include('style'); ?>

    <!-- Dependencias externas -->
=======
    <title><?= TITULO ?></title>
    <?!= include('style'); ?>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.1/main.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  </head>

  <body>
<<<<<<< HEAD
    <div class="grid-container">
      <!-- Logo Section -->
      <div class="logo-section">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/1/19/CCU_LOGO.png"
          alt="Logo CCU"
          class="company-logo-img"
        />
      </div>

      <!-- Upload Button -->
      <button
        id="uploadButton"
        class="upload-btn"
        aria-label="Cargar archivo Excel"
      >
        <span aria-hidden="true">üìÅ</span>
        <span>CARGAR<br />ARCHIVO</span>
      </button>

      <!-- Upload Movements Button -->
      <button
        id="uploadMovementsButton"
        class="upload-btn movements-btn"
        aria-label="Cargar archivo de movimientos"
        style="display: none;"
      >
        <span aria-hidden="true">üìä</span>
        <span>CARGAR<br />MOVIMIENTOS</span>
      </button>

      <!-- Stats Section -->
      <div class="stats-container">
        <?!= include('statsCard'); ?>
      </div>

      <!-- Map Section -->
      <div class="mapa-section">
        <div class="mapa-header">
          <h2>MAPA DEL ALMAC√âN</h2>
          <div class="map-controls-header">
            <select
              id="tipoMapaSelector"
              class="selector-mapa"
              aria-label="Tipo de visualizaci√≥n"
            >
              <option value="ocupacion">Ver Ocupaci√≥n</option>
              <option value="vencimiento">Ver Vencimientos</option>
              <option value="movimientos">Ver Movimientos</option>
            </select>
            <select
              id="tipoMovimientoSubSelector"
              class="selector-mapa"
              aria-label="Tipo de movimiento"
              style="display: none; margin-left: 10px;"
            >
              <option value="salidas">Salidas</option>
              <option value="entradas">Entradas</option>
            </select>
          </div>
        </div>

        <!-- Map Controls -->
        <div class="map-controls">
          <button id="fullscreen-btn" class="map-control-btn" title="Pantalla completa">
            <span>‚õ∂</span>
          </button>
          <button id="zoom-in-btn" class="map-control-btn" title="Acercar">
            <span>+</span>
          </button>
          <button id="zoom-out-btn" class="map-control-btn" title="Alejar">
            <span>‚àí</span>
          </button>
          <button id="reset-zoom-btn" class="map-control-btn" title="Restablecer vista">
            <span>‚åÇ</span>
          </button>
          <div id="zoom-indicator" class="zoom-indicator" title="Nivel de zoom">
            100%
          </div>
        </div>

        <div
          id="svg-container"
          class="svg-container"
          role="img"
          aria-label="Mapa interactivo de la bodega"
        >
          <div class="svg-loading">
            <div class="loader-spinner"></div>
            <p>Cargando mapa...</p>
=======
    <div class="container">
      <!-- Encabezado de la p√°gina -->
      <header>
        <div class="header-controls">
          <button id="uploadButton" class="btn-upload">Cargar Archivo</button>

          <select id="tipoMapaSelector" class="selector-mapa">
            <option value="ocupacion">Ver Ocupaci√≥n</option>
            <option value="vencimiento">Ver Vencimientos</option>
          </select>
        </div>
      </header>

      <!-- Dashboard Cards -->
      <div class="dashboard-header">
        <div class="company-logo">
          <img
            src="https://upload.wikimedia.org/wikipedia/commons/1/19/CCU_LOGO.png"
            alt="Logo CCU"
          />
        </div>
        <div class="dashboard-cards">
          <!-- Card utilizacion -->
          <div class="card" id="card-utilizacion">
            <h3>% Utilizado</h3>
            <div class="chart-container">
              <canvas id="utilizacionChart"></canvas>
            </div>
            <div class="card-loading" style="display: flex">
              <div class="card-loader"></div>
              <span>Cargando...</span>
            </div>
          </div>

          <!-- Card ubicaciones con error -->
          <div class="card" id="card-errores">
            <h3>Ubicaciones con Error</h3>
            <div class="card-content">
              <span class="card-value"></span>
              <span class="card-label">Ubicaciones</span>
            </div>
            <div class="card-loading" style="display: flex">
              <div class="card-loader"></div>
              <span>Cargando...</span>
            </div>
          </div>

          <!-- Card SKUs con bajo stock  -->
          <div class="card">
            <h3>
              Ubicaciones con menos de
              <input
                type="number"
                id="stockThreshold"
                min="1"
                max="100"
                value="10"
              />
              pallet
            </h3>
            <div class="card-content">
              <span class="card-value"></span>
            </div>
            <div class="card-loading" style="display: flex">
              <div class="card-loader"></div>
              <span>Cargando...</span>
            </div>
          </div>

          <!-- Card productos retenidos -->
          <div class="card">
            <h3>Pallets retenidos</h3>
            <div class="card-content">
              <span class="card-value"></span>
              <span class="card-label">Log√≠stico</span>
              <br />
              <span class="card-value"></span>
              <span class="card-label">L√≠neas</span>
            </div>
            <div class="card-loading" style="display: flex">
              <div class="card-loader"></div>
              <span>Cargando...</span>
            </div>
          </div>

          <!-- Card Datos historicos -->
          <div class="card">
            <h3>Datos Hist√≥ricos</h3>
            <div class="card-content">
              <button id="btnHistoricos" class="btn-historicos">
                Ver hist√≥ricos
              </button>
            </div>
            <div class="card-loading" style="display: flex">
              <div class="card-loader"></div>
              <span>Cargando...</span>
            </div>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
          </div>
        </div>
      </div>

<<<<<<< HEAD
      <!-- Legend Section -->
      <div class="leyenda-section">
        <div class="leyenda-header">LEYENDA</div>

        <div id="leyenda-ocupacion" class="leyenda-content">
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #2d572c"></div>
            <span>Vac√≠o</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #00ff00"></div>
            <span>0-25%</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #ffff00"></div>
            <span>25-50%</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #ff8800"></div>
            <span>50-75%</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #ff0000"></div>
            <span>75-100%</span>
          </div>
        </div>

        <div id="leyenda-vencimiento" class="leyenda-content hidden">
          <div class="leyenda-item">
            <div class="leyenda-color color-alto"></div>
            <span>75-100%</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color color-medio"></div>
            <span>50-75%</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color color-bajo"></div>
            <span>25-50%</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color color-critico"></div>
            <span>0-25%</span>
          </div>
        </div>

        <div id="leyenda-movimientos" class="leyenda-content hidden">
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #2d572c"></div>
            <span>Sin movimiento</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #00ff00"></div>
            <span>Bajo (0-25%)</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #ffff00"></div>
            <span>Medio (25-50%)</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #ff8800"></div>
            <span>Alto (50-75%)</span>
          </div>
          <div class="leyenda-item">
            <div class="leyenda-color" style="background-color: #ff0000"></div>
            <span>Muy Alto (75-100%)</span>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section">
        <div class="filter-header">FILTROS</div>

        <!-- Filtro SKU -->
        <div class="filter-group">
          <label for="filtro-sku">SKU</label>
          <div class="autocomplete-container">
            <input
              type="text"
              id="filtro-sku"
              class="filter-input"
              placeholder="Buscar SKU"
              aria-describedby="sku-hint"
              autocomplete="off"
            />
          </div>
        </div>

        <!-- Filtro Ubicaci√≥n -->
        <div class="filter-group">
          <label for="filtro-ubicacion">Ubicaci√≥n</label>
          <div class="autocomplete-container">
            <input
              type="text"
              id="filtro-ubicacion"
              class="filter-input"
              placeholder="Ej: A-01-01"
              aria-describedby="ubicacion-hint"
              autocomplete="off"
            />
          </div>
        </div>

        <!-- Filtro √Åreas -->
        <div class="filter-group">
          <label for="areas-dropdown">√Åreas</label>
          <div class="dropdown-container">
            <button
              type="button"
              id="areas-dropdown"
              class="filter-input dropdown-btn"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <span id="areas-selected-text">Todas</span>
            </button>
            <div
              class="dropdown-content"
              role="menu"
              aria-labelledby="areas-dropdown"
            >
              <div class="checkbox-item all-checkbox">
                <label>
                  <input type="checkbox" id="select-all-areas" checked />
                  <span>Seleccionar todas</span>
                </label>
              </div>
              <div class="area-separator"></div>
              <div id="areas-list"></div>
=======
      <!-- Filtros Horizontales -->
      <div class="filtros-container">
        <div class="filtro-grupo">
          <div class="filtro-item">
            <label for="filtro-sku">SKU</label>
            <input type="text" id="filtro-sku" placeholder="Filtrar por SKU" />
          </div>

          <div class="filtro-item">
            <label for="filtro-area">√Åreas</label>
            <div class="dropdown-container">
              <button class="dropdown-btn" id="btn-areas">
                Seleccionar √°reas
              </button>
              <div class="dropdown-content" id="filtro-area-container">
                <!-- Las checkboxes se a√±adir√°n din√°micamente -->
                <div class="checkbox-item all-checkbox">
                  <input type="checkbox" id="area-all" value="todas" />
                  <label for="area-all">(Seleccionar todo)</label>
                </div>
              </div>
            </div>
          </div>

          <div class="filtro-item">
            <label for="filtro-ubicacion">Ubicaci√≥n</label>
            <input
              type="text"
              id="filtro-ubicacion"
              placeholder="Filtrar por ubicaci√≥n"
            />
          </div>

          <div class="filtro-item">
            <label for="filtro-producto">Producto</label>
            <input
              type="text"
              id="filtro-producto"
              placeholder="Filtrar por producto"
            />
          </div>

          <div class="filtro-item">
            <label for="filtro-lpn">LPN</label>
            <input type="text" id="filtro-lpn" placeholder="Filtrar por LPN" />
          </div>
        </div>

        <div class="filtro-botones">
          <button id="btn-filtrar">Filtrar</button>
          <button id="btn-limpiar">Limpiar</button>
        </div>
      </div>

      <!-- Vista del mapa (activa por defecto) -->
      <div id="vista-mapa" class="vista-contenido active">
        <div id="resultado-filtro"></div>

        <div class="dashboard-container">
          <div class="map-container">
            <div id="svg-ocupacion" class="svg-container">
              <div id="loading-svg-ocupacion" class="svg-loading">
                <div class="loader-spinner"></div>
                <p>Cargando mapa...</p>
              </div>
              <?!= SVG_OCUPACION ?>
            </div>

            <div
              id="svg-vencimiento"
              class="svg-container"
              style="display: none"
            >
              <div id="loading-svg-vencimiento" class="svg-loading">
                <div class="loader-spinner"></div>
                <p>Cargando mapa...</p>
              </div>
              <?!= SVG_VENCIMIENTO ?>
            </div>
          </div>

          <div class="side-leyend">
            <div class="leyenda-vertical" id="leyenda-ocupacion">
              <h3>Ocupaci√≥n</h3>
              <div class="item-leyenda">
                <!-- Verde -->
                <div
                  class="color-muestra"
                  style="background-color: #00ff00"
                ></div>
                <span>0-25%</span>
              </div>
              <div class="item-leyenda">
                <!-- Amarillo -->
                <div
                  class="color-muestra"
                  style="background-color: #ffff00"
                ></div>
                <span>25-50%</span>
              </div>
              <div class="item-leyenda">
                <!-- Naranjo -->
                <div
                  class="color-muestra"
                  style="background-color: #ff8800"
                ></div>
                <span>50-75%</span>
              </div>
              <div class="item-leyenda">
                <!-- Rojo -->
                <div
                  class="color-muestra"
                  style="background-color: #ff0000"
                ></div>
                <span>75-100%</span>
              </div>
              <div class="item-leyenda">
                <div
                  class="color-muestra"
                  style="background-color: #cccccc"
                ></div>
                <span>Sin datos</span>
              </div>
            </div>

            <div
              class="leyenda-vertical"
              id="leyenda-vencimiento"
              style="display: none"
            >
              <h3>Vida √ötil</h3>
              <div class="item-leyenda">
                <div
                  class="color-muestra"
                  style="background-color: #00ff00"
                ></div>
                <span>75-100%</span>
              </div>
              <div class="item-leyenda">
                <div
                  class="color-muestra"
                  style="background-color: #ffff00"
                ></div>
                <span>50-75%</span>
              </div>
              <div class="item-leyenda">
                <!-- Naranjo -->
                <div
                  class="color-muestra"
                  style="background-color: #ff8800"
                ></div>
                <span>25-50%</span>
              </div>
              <div class="item-leyenda">
                <div
                  class="color-muestra"
                  style="background-color: #ff0000"
                ></div>
                <span>0-25%</span>
              </div>
              <div class="item-leyenda">
                <div class="color-muestra multiple-vidas">
                  <div
                    style="
                      position: absolute;
                      left: 0;
                      top: 0;
                      width: 50%;
                      height: 100%;
                      background: radial-gradient(
                        circle,
                        #ffff00 0%,
                        #ff7700 100%
                      );
                    "
                  ></div>
                </div>
                <span>M√∫ltiples vidas √∫tiles</span>
              </div>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
            </div>
          </div>
        </div>

<<<<<<< HEAD
        <div class="filter-buttons">
          <button
            id="btn-filtrar"
            class="filter-btn"
            aria-label="Aplicar filtros"
          >
            Filtrar
          </button>
          <button
            id="btn-limpiar"
            class="filter-btn filter-btn-clear"
            aria-label="Limpiar filtros"
          >
            Limpiar
          </button>
        </div>

        <!-- Resultado de filtros -->
        <div
          id="resultado-filtro"
          class="filter-results hidden"
          role="status"
          aria-live="polite"
        >
          <p id="filter-summary"></p>
        </div>

        <!-- Filtros espec√≠ficos para movimientos -->
        <div id="filtros-movimientos" class="movements-filters hidden">
          <div class="filter-header">FILTROS DE MOVIMIENTOS</div>
          
          <!-- Filtro por tipo de operaci√≥n -->
          <div class="filter-group">
            <label for="filtro-operacion">Tipo de Operaci√≥n</label>
            <select id="filtro-operacion" class="filter-input">
              <option value="">Todas las operaciones</option>
              <option value="List Pick">List Pick (Picking)</option>
              <option value="Trailer load">Trailer Load (Carga)</option>
              <option value="Undirected Load Transfer">Transferencia</option>
              <option value="Inventory Adjustment">Ajuste de Inventario</option>
            </select>
          </div>

          <!-- Filtro por rango de frecuencia -->
          <div class="filter-group">
            <label for="filtro-frecuencia">Rango de Frecuencia</label>
            <select id="filtro-frecuencia" class="filter-input">
              <option value="">Todas las frecuencias</option>
              <option value="alta">Alta actividad (75-100%)</option>
              <option value="media">Actividad media (50-75%)</option>
              <option value="baja">Baja actividad (25-50%)</option>
              <option value="minima">Actividad m√≠nima (0-25%)</option>
              <option value="sin-movimiento">Sin movimiento</option>
            </select>
          </div>

          <!-- Filtro por umbral m√≠nimo -->
          <div class="filter-group">
            <label for="filtro-umbral">Movimientos m√≠nimos</label>
            <input 
              type="number" 
              id="filtro-umbral" 
              class="filter-input" 
              placeholder="Ej: 5"
              min="0"
              title="Mostrar solo ubicaciones con X o m√°s movimientos"
            >
          </div>

          <!-- Filtro por per√≠odo espec√≠fico -->
          <div class="filter-group">
            <label for="filtro-dia-semana">D√≠a de la semana</label>
            <select id="filtro-dia-semana" class="filter-input">
              <option value="">Todos los d√≠as</option>
              <option value="1">Lunes</option>
              <option value="2">Martes</option>
              <option value="3">Mi√©rcoles</option>
              <option value="4">Jueves</option>
              <option value="5">Viernes</option>
              <option value="6">S√°bado</option>
              <option value="0">Domingo</option>
            </select>
          </div>

          <div class="filter-buttons">
            <button
              id="btn-filtrar-movimientos"
              class="filter-btn"
              aria-label="Aplicar filtros de movimientos"
            >
              Filtrar Movimientos
            </button>
            <button
              id="btn-limpiar-movimientos"
              class="filter-btn filter-btn-clear"
              aria-label="Limpiar filtros de movimientos"
            >
              Limpiar Filtros
            </button>
          </div>

          <!-- An√°lisis avanzado -->
          <div class="analysis-section" style="margin-top: 15px;">
            <button
              id="btn-analizar-patrones"
              class="filter-btn"
              style="width: 100%; background: #28a745; color: white;"
              aria-label="Generar an√°lisis de patrones"
            >
              üìä Analizar Patrones
            </button>
          </div>

          <!-- Resultado de filtros de movimientos -->
          <div
            id="resultado-filtro-movimientos"
            class="filter-results hidden"
            role="status"
            aria-live="polite"
          >
            <p id="movements-filter-summary"></p>
          </div>
        </div>
      </div>

      <!-- Hist√≥ricos Button -->
      <button class="historicos-btn" id="btn-historicos">Ver hist√≥ricos</button>

      <!-- Bottom Section -->
      <div class="bottom-section">
        <!-- Tabla de vencimientos -->
        <div class="tabla-section">
          <div class="section-header">TABLA VENCIMIENTOS</div>
          <div class="table-container">
            <table class="tabla-vencimientos" id="tabla-vencimientos">
              <thead>
                <tr>
                  <th
                    class="btn-ordenar"
                    data-campo="sku"
                    tabindex="0"
                    role="button"
                  >
                    SKU
                  </th>
                  <th
                    class="btn-ordenar"
                    data-campo="descripcion"
                    tabindex="0"
                    role="button"
                  >
                    Descripci√≥n
                  </th>
                  <th
                    class="btn-ordenar"
                    data-campo="dias"
                    tabindex="0"
                    role="button"
                  >
                    D√≠as
                  </th>
                  <th
                    class="btn-ordenar"
                    data-campo="cantidad"
                    tabindex="0"
                    role="button"
                  >
                    Cantidad
                  </th>
                  <th>Detalle</th>
                </tr>
              </thead>
              <tbody id="vencimientos-tbody">
                <tr>
                  <td colspan="5" class="text-center">Cargando datos...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="data-summary">
            <p id="resumen-vencimientos">Total: 0 productos</p>
          </div>
        </div>

        <!-- Calendario -->
        <div class="calendario-section">
          <div class="section-header">CALENDARIO VENCIMIENTOS</div>
          <div
            id="calendar"
            role="application"
            aria-label="Calendario de vencimientos"
          ></div>
=======
        <!-- Contenedor para tabla y calendario (lado a lado) -->
        <div class="bottom-panels">
          <div class="data-section vencimientos-section">
            <!-- <h3 class="data-header">Productos pr√≥ximos a vencer</h3> -->
            <div class="data-content">
              <table class="dashboard-table" id="tabla-vencimientos">
                <thead>
                  <tr>
                    <th id="ordenar-sku" class="btn-ordenar">SKU</th>
                    <th id="ordenar-descripcion" class="btn-ordenar">
                      Descripci√≥n
                    </th>
                    <th id="ordenar-cantidad" class="btn-ordenar">Pallets</th>
                    <th id="ordenar-fecha" class="btn-ordenar">
                      Fecha de Vencimiento
                    </th>
                    <th id="ordenar-cajas" class="btn-ordenar">Cajas</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Se llenar√° din√°micamente con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="data-section calendario-section">
            <!-- <h3 class="data-header">Calendario de Vencimientos</h3> -->
            <div id="calendar"></div>
          </div>
        </div>
        <div class="footer">&copy; Sistema de mapeo de bodega</div>
      </div>

      <!-- Vista del calendario -->
      <div id="vista-calendario" class="vista-contenido" style="display: none">
        <div class="calendario-container">
          <div id="calendar"></div>
        </div>

        <div
          id="carga-calendario"
          style="display: none; text-align: center; padding: 20px"
        >
          <div
            style="
              display: inline-block;
              border: 4px solid #f3f3f3;
              border-top: 4px solid #3498db;
              border-radius: 50%;
              width: 30px;
              height: 30px;
              animation: spin 2s linear infinite;
            "
          ></div>
          <p>Cargando datos de vencimientos...</p>
          <style>
            @keyframes spin {
              0% {
                transform: rotate(0deg);
              }

              100% {
                transform: rotate(360deg);
              }
            }
          </style>
        </div>

        <div
          id="error-calendario"
          style="
            display: none;
            text-align: center;
            padding: 20px;
            color: #f44336;
          "
        >
          <p>
            No se pudieron cargar los datos de vencimientos. Por favor, intente
            nuevamente m√°s tarde.
          </p>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
        </div>
      </div>
    </div>

<<<<<<< HEAD
    <!-- Tooltip -->
    <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

    <!-- Modal de detalles -->
    <div
      id="ubicacionModal"
      class="modal ubicacion-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
    >
      <div class="modal-content ubicacion-modal-content">
        <button class="close-modal" aria-label="Cerrar modal">&times;</button>
        <div id="modalContent"></div>
      </div>
    </div>

    <!-- Modal de vencimientos -->
    <div
      id="vencimiento-modal"
      class="modal vencimiento-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="vencimiento-modal-title"
    >
      <div class="modal-content vencimiento-modal-content">
        <button
          id="close-vencimiento-modal"
          class="close-modal"
          aria-label="Cerrar modal"
        >
          &times;
        </button>
=======
    <!-- Tooltips y modales -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Modal de detalle de ubicaci√≥n -->
    <div id="ubicacion-modal" class="ubicacion-modal">
      <div class="ubicacion-modal-content">
        <span class="close-modal" id="close-modal">&times;</span>
        <div id="ubicacion-detalle"></div>
      </div>
    </div>

    <!-- Modal de detalle de vencimientos -->
    <div id="vencimiento-modal" class="ubicacion-modal">
      <div class="ubicacion-modal-content">
        <span class="close-modal" id="close-vencimiento-modal">&times;</span>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
        <div id="vencimiento-detalle"></div>
      </div>
    </div>

<<<<<<< HEAD
    <!-- Panel deslizable -->
    <?!= include('scriptSlidePanel'); ?>

    <!-- Panel de movimientos -->
    <?!= include('scriptMovementsPanel'); ?>

    <!-- Status bar -->
    <!-- <div class="status-bar" role="status" aria-live="polite">
      <span id="lastUpdateText">Cargando informaci√≥n...</span>
    </div> -->

    <!-- Scripts modularizados refactorizados -->
    <?!= include('js/config.js.html'); ?>
    <?!= include('js/utils.js.html'); ?>
    <?!= include('js/data-service.js.html'); ?>
    <?!= include('js/map-controller.js.html'); ?>
    <?!= include('js/filter-manager.js.html'); ?>
    <?!= include('js/map-navigator.js.html'); ?>

    <!-- Nuevos m√≥dulos refactorizados -->
    <?!= include('js/dom-manager.js.html'); ?>
    <?!= include('js/tooltip-manager.js.html'); ?>
    <?!= include('js/modal-manager.js.html'); ?>
    <?!= include('js/svg-manager.js.html'); ?>
    <?!= include('js/table-manager.js.html'); ?>
    <?!= include('js/area-manager.js.html'); ?>
    <?!= include('js/movements-helper.js.html'); ?>
    <?!= include('js/movements-filter-manager.js.html'); ?>
    <?!= include('js/movements-analytics.js.html'); ?>

    <!-- Scripts principales simplificados -->
    <?!= include('scripts'); ?>

    <!-- Inicializador de aplicaci√≥n -->
    <?!= include('js/app-initializer.js.html'); ?>

    <!-- Scripts espec√≠ficos -->
    <?!= include('scriptCalendario'); ?>
    <?!= include('autocompletar'); ?>

    <!-- FullCalendar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.1/main.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.1/locales/es.js"></script>
=======
    <!-- Panel deslizable para carga de archivos -->
    <div class="slide-panel" id="uploadPanel">
      <span class="close-panel" id="closeUploadPanel">&times;</span>
      <h2 class="title-slide-panel">Cargar archivo de inventario</h2>
      <select id="fuenteDatosSelector" class="selector-fuente">
        <option value="blueyonder">BlueYonder</option>
        <option value="wep">WEP</option>
      </select>

      <div class="upload-area" id="uploadArea">
        <p>Arrastre su archivo Excel aqu√≠ o</p>
        <input
          type="file"
          id="fileInput"
          accept=".xlsx, .xls"
          style="display: none"
        />
        <button id="selectButton" class="btn btn-primary">
          Seleccionar archivo
        </button>
        <button id="selectDriveButton" class="btn btn-primary">
          Seleccionar de Drive
        </button>
        <div id="fileInfo" class="file-info"></div>
      </div>

      <div
        class="file-date-selector"
        id="fileDateSelector"
        style="display: none; margin-top: 15px"
      >
        <div class="file-date-header">Seleccione la fecha del archivo:</div>
        <div class="date-inputs">
          <div class="input-group">
            <label for="fileDate">Fecha:</label>
            <input type="date" id="fileDate" class="fecha-input" />
          </div>
          <div class="input-group">
            <label for="fileTime">Hora:</label>
            <input type="time" id="fileTime" class="hora-input" value="00:00" />
          </div>
        </div>
        <div class="input-hint">
          Si no selecciona fecha, se usar√° la fecha actual.
        </div>
      </div>

      <div
        class="progress-container"
        id="progressContainer"
        style="display: none"
      >
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div class="button-group">
        <button id="processFileButton" class="btn btn-primary" disabled>
          Procesar archivo
        </button>
        <button
          id="cancelProcessButton"
          class="btn btn-primary"
          style="display: none"
        >
          Cancelar
        </button>
      </div>

      <div id="uploadResult" style="margin-top: 20px"></div>
    </div>

    <!-- Overlay para cerrar paneles -->
    <div class="panel-overlay" id="panelOverlay"></div>

    <!--   Scripts de datos -->
    <?!= include('scripts'); ?>
    <?!= include('scriptCalendario'); ?>
    <?!= include('scriptsSlidePanel'); ?>
    <?!= include('autocompletar'); ?>
    <?!= include('statsCards'); ?>
    <?!= include('zoomControls'); ?>

    <script>
      const AREAS_CONSIDERADAS = <?!= JSON.stringify(AREAS_CONSIDERADAS) ?>;
      const PASILLO_RACK = <?!= JSON.stringify(PASILLO_RACK) ?>;
    </script>

    <script id="datos-productos" type="application/json">
      <?!= mapaSKU ?>
    </script>

    <!-- Scripts principales -->
    <script>
      let datosProductos = null;

      // C√≥digo de inicializaci√≥n
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM cargado completamente");
        setupNavigation();

        // Inicializar modal
        const modal = document.getElementById("ubicacion-modal");
        const closeModal = document.getElementById("close-modal");
        const detalleContainer = document.getElementById("ubicacion-detalle");

        // Cerrar modal al hacer clic en X
        closeModal.addEventListener("click", function () {
          modal.style.display = "none";
        });

        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener("click", function (event) {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });

        // FUNCIONALIDAD DE TOOLTIPS
        const tooltip = document.getElementById("tooltip");
        const svgElements = document.querySelectorAll("g[id][data-ubicacion]");

        // A√±adir listeners para mostrar tooltips y detectar clics
        svgElements.forEach(function (element) {
          // Tambi√©n seleccionar los rect√°ngulos dentro de cada grupo
          const rects = element.querySelectorAll("rect.ubicacion");

          // A√±adir los eventos al grupo g
          element.addEventListener("mousemove", showTooltip);
          element.addEventListener("mouseout", hideTooltip);
          element.addEventListener("mouseover", highlightElement);
          element.addEventListener("mouseout", unhighlightElement);
          element.addEventListener("click", showUbicacionDetalle);

          // A√±adir los mismos eventos a cada rect√°ngulo dentro del grupo
          rects.forEach(function (rect) {
            rect.addEventListener("mousemove", showTooltip);
            rect.addEventListener("mouseout", hideTooltip);
            rect.addEventListener("mouseover", highlightElement);
            rect.addEventListener("mouseout", unhighlightElement);
            rect.addEventListener("click", showUbicacionDetalle);
          });
        });

        // FUNCIONALIDAD DE FILTRADO DE PRODUCTOS
        const btnFiltrar = document.getElementById("btn-filtrar");
        const btnLimpiar = document.getElementById("btn-limpiar");
        const inputSku = document.getElementById("filtro-sku");
        const resultadoFiltro = document.getElementById("resultado-filtro");

        console.log("Elementos del filtro:", {
          btnFiltrar: !!btnFiltrar,
          btnLimpiar: !!btnLimpiar,
          inputSku: !!inputSku,
        });

        // Asociar eventos a los botones
        if (btnFiltrar) {
          btnFiltrar.addEventListener("click", function () {
            console.log("Bot√≥n filtrar clickeado");
            aplicarTodosFiltros();
            // filtrarPorSku(inputSku);
          });
        }

        if (inputSku) {
          inputSku.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
              console.log("Enter presionado en el filtro");
              filtrarPorSku(inputSku);
            }
          });
        }

        if (btnLimpiar) {
          btnLimpiar.addEventListener("click", function () {
            console.log("Bot√≥n limpiar clickeado");
            limpiarFiltro(true);
          });
        }

        window.setupUploadPanel();
        const tipoMapaSelector = document.getElementById("tipoMapaSelector");
        const svgOcupacion = document.getElementById("svg-ocupacion");
        const svgVencimiento = document.getElementById("svg-vencimiento");
        const leyendaOcupacion = document.getElementById("leyenda-ocupacion");
        const leyendaVencimiento = document.getElementById(
          "leyenda-vencimiento"
        );

        setTimeout(function () {
          const svgActual = document
            .getElementById("svg-ocupacion")
            .querySelector("svg");
          if (svgActual) {
            ajustarSVGViewBox(svgActual);
            console.log("SVG inicial ajustado autom√°ticamente");
          }
        }, 500);

        // Cargar FullCalendar de CDN
        var scriptCalendar = document.createElement("script");
        scriptCalendar.src =
          "https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js";
        scriptCalendar.onload = function () {
          var scriptLocale = document.createElement("script");
          scriptLocale.src =
            "https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/es.min.js";
          scriptLocale.onload = function () {
            if (
              document.getElementById("vista-calendario").style.display !==
              "none"
            ) {
              inicializarCalendario();
            }
          };
          document.head.appendChild(scriptLocale);
        };
        document.head.appendChild(scriptCalendar);

        // Cargar CSS de FullCalendar
        var link = document.createElement("link");
        link.rel = "stylesheet";
        link.href =
          "https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css";
        document.head.appendChild(link);
      });

      function ajustarSVGViewBox(svgElement) {
        if (!svgElement) return;

        if (
          svgElement.hasAttribute("data-scale") &&
          parseFloat(svgElement.getAttribute("data-scale")) !== 1
        ) {
          return;
        }

        // Obtener todos los elementos g que representan ubicaciones
        const ubicaciones = svgElement.querySelectorAll(
          "g[id][data-ubicacion]"
        );

        if (ubicaciones.length > 0) {
          // Calcular los l√≠mites del contenido real
          let minX = Infinity,
            minY = Infinity,
            maxX = 0,
            maxY = 0;

          ubicaciones.forEach(function (ubi) {
            const rect = ubi.querySelector("rect");
            if (rect) {
              const x = parseFloat(rect.getAttribute("x") || 0);
              const y = parseFloat(rect.getAttribute("y") || 0);
              const width = parseFloat(rect.getAttribute("width") || 0);
              const height = parseFloat(rect.getAttribute("height") || 0);

              minX = Math.min(minX, x);
              minY = Math.min(minY, y);
              maxX = Math.max(maxX, x + width);
              maxY = Math.max(maxY, y + height);
            }
          });

          // A√±adir un margen del 1%
          const margin = 0.01;
          const width = maxX - minX;
          const height = maxY - minY;
          const marginX = width * margin;
          const marginY = height * margin;

          const viewBox = `${minX - marginX} ${minY - marginY} ${
            width + marginX * 2
          } ${height + marginY * 2}`;
          svgElement.setAttribute("viewBox", viewBox);

          if (!svgElement.hasAttribute("data-original-viewbox")) {
            svgElement.setAttribute("data-original-viewbox", viewBox);
          }

          if (!svgElement.hasAttribute("data-scale")) {
            svgElement.setAttribute("data-scale", "1");
            svgElement.setAttribute("data-pan-x", "0");
            svgElement.setAttribute("data-pan-y", "0");
            svgElement.setAttribute("data-zoomed", "false");
          }

          const aspectRatio = width / height;
          const parentContainer = svgElement.parentElement;

          if (parentContainer) {
            const containerWidth = parentContainer.clientWidth;
            const containerHeight = parentContainer.clientHeight;

            if (aspectRatio > 1) {
              // SVG m√°s ancho que alto
              svgElement.style.width = "100%";
              svgElement.style.height = "auto";
            } else {
              // SVG m√°s alto que ancho
              svgElement.style.width = "auto";
              svgElement.style.height = "100%";
            }
          }

          console.log("SVG ajustado para mostrar todo el contenido:", viewBox);
        }
      }

      function setupNavigation() {
        const vencimientoModal = document.getElementById("vencimiento-modal");
        const closeVencimientoModal = document.getElementById(
          "close-vencimiento-modal"
        );
        if (vencimientoModal && closeVencimientoModal) {
          closeVencimientoModal.addEventListener("click", function () {
            vencimientoModal.style.display = "none";
          });

          window.addEventListener("click", function (event) {
            if (event.target === vencimientoModal) {
              vencimientoModal.style.display = "none";
            }
          });
        }
      }
    </script>
>>>>>>> 50c62eb1b443212dff1e0d4c959c6a6b060a1ef9
  </body>
</html>
